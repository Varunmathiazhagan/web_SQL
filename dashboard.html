<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SQLi Scan Dashboard</title>
  <style>
    :root{
      --bg:#0b1220;--card:#0e1a40;--muted:#1a2a57;--text:#d6e1ff;--text-dim:#9fb0e0;--accent:#4c6fff;--danger:#ff6b6b
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 system-ui, Segoe UI, Arial, sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:1;background:#0d1430;border-bottom:1px solid #1c2545;padding:14px 18px}
    header h1{margin:0;font-size:18px}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .card{background:var(--card);border:1px solid var(--muted);border-radius:10px;padding:14px;margin-bottom:16px}
    label{color:var(--text-dim)}
    input[type=text]{background:#0b1736;border:1px solid var(--muted);color:var(--text);border-radius:8px;padding:8px 10px;min-width:260px}
    .btn{background:var(--accent);border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#22356f}
    .stat{color:var(--text-dim)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--muted);padding:8px 10px;text-align:left;vertical-align:top}
    th{color:var(--text-dim);font-weight:600}
    td.wrap{max-width:380px;overflow-wrap:anywhere}
    .badge{display:inline-block;background:#24377b;color:#cfe0ff;border:1px solid #3950a3;padding:2px 8px;border-radius:999px;font-size:12px}
    footer{color:var(--text-dim);padding:20px 0}
    .error{color:var(--danger)}
  </style>
</head>
<body>
  <header>
    <h1>SQLi Scan Dashboard</h1>
  </header>
  <div class="container">
    <div class="card">
      <div class="toolbar">
        <label>API Base</label>
        <input id="apiBase" type="text" value="http://127.0.0.1:5050" />
        <label>Start URL</label>
        <input id="startUrl" type="text" value="http://localhost:8000" />
        <button id="runScan" class="btn">Run Scan</button>
        <input id="filter" type="text" placeholder="Filter by URL, param, technique, payload..." />
        <button id="clear" class="btn btn-secondary">Clear</button>
        <span id="status" class="stat"></span>
      </div>
      <div id="msg" class="stat"></div>
    </div>

    <div class="card">
      <div class="toolbar" style="justify-content:space-between">
        <div>
          <span class="badge" id="countBadge">0 findings</span>
        </div>
        <div class="stat">Updated <span id="updated">never</span></div>
      </div>
      <div style="overflow:auto">
        <table id="results">
          <thead>
            <tr>
              <th style="min-width:110px">Technique</th>
              <th style="min-width:240px">URL</th>
              <th>Param</th>
              <th style="min-width:240px">Payload</th>
              <th style="min-width:260px">Evidence</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <footer>Tip: Place this file next to <code>latest_scan.json</code>. If the browser blocks loading local files, run a local server in this folder.</footer>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const tbody = document.querySelector('#results tbody');
  const statusEl = $('#status');
  const msgEl = $('#msg');
  const apiBaseEl = $('#apiBase');
  const startUrlEl = $('#startUrl');
  let all = [];

  function esc(t){ const s=document.createElement('span'); s.textContent=String(t??''); return s.innerHTML; }
  function setCount(n){ document.querySelector('#countBadge').textContent = `${n} finding${n===1?'':'s'}`; }
  function setUpdated(ts){ document.querySelector('#updated').textContent = ts ? new Date(ts).toLocaleString() : 'never'; }

  function render(list){
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    list.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><span class="badge">${esc(r.technique||'')}</span></td>
        <td class="wrap">${esc(r.url||'')}</td>
        <td>${esc(r.param||'')}</td>
        <td class="wrap">${esc(r.payload||'')}</td>
        <td class="wrap">${esc(r.evidence||'')}</td>
      `;
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
    setCount(list.length);
  }

  function applyFilter(){
    const q = ($('#filter').value || '').toLowerCase().trim();
    if(!q){ render(all); return; }
    const filtered = all.filter(r => ['url','param','technique','payload','evidence'].some(k => (r[k]||'').toString().toLowerCase().includes(q)));
    render(filtered);
  }

  async function fetchResults(){
    const base = apiBaseEl.value.replace(/\/$/, '');
    statusEl.textContent = 'Loading results...';
    try{
      const resp = await fetch(base + '/api/results', { cache: 'no-store' });
      if(!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      all = Array.isArray(data.results) ? data.results : [];
      render(all);
      setUpdated(data.updated);
      statusEl.textContent = `Loaded ${all.length} results`;
    }catch(e){
      statusEl.textContent = '';
      msgEl.textContent = 'Failed to load from API. Is the Flask dashboard running?';
    }
  }

  async function runScan(){
    const base = apiBaseEl.value.replace(/\/$/, '');
    const startUrl = startUrlEl.value.trim();
    statusEl.textContent = 'Starting scan...';
    try{
      const resp = await fetch(base + '/api/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ start_url: startUrl })
      });
      if(!resp.ok) throw new Error('HTTP ' + resp.status);
      statusEl.textContent = 'Scan started. Polling results...';
      // Poll a few times for fresh results
      let attempts = 0;
      const poll = async () => {
        attempts++;
        await new Promise(r => setTimeout(r, 1500));
        await fetchResults();
        if(attempts < 10) poll();
      };
      poll();
    }catch(e){
      statusEl.textContent = '';
      msgEl.textContent = 'Failed to start scan. Check API Base or server logs.';
    }
  }

  // Wire up events
  document.querySelector('#runScan').addEventListener('click', runScan);
  document.querySelector('#clear').addEventListener('click', () => { document.querySelector('#filter').value=''; render(all); });
  document.querySelector('#filter').addEventListener('input', applyFilter);

  // Initial load
  fetchResults();
})();
</script>
</body>
</html>
